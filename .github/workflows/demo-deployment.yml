name: Demo Environment Deployment

on:
  push:
    branches: [ demo ]
  workflow_dispatch:
    inputs:
      demo_version:
        description: 'Demo version tag'
        required: true
        default: 'latest'
      data_preset:
        description: 'Demo data preset'
        type: choice
        options:
          - comprehensive
          - performance
          - small_scale
          - large_scale
        default: 'comprehensive'

env:
  DEMO_VERSION: ${{ inputs.demo_version || 'latest' }}
  DATA_PRESET: ${{ inputs.data_preset || 'comprehensive' }}

jobs:
  build-demo:
    name: Build Demo Environment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci
          cd ../backend
          pip install -r requirements.txt

      - name: Generate demo data
        run: |
          cd backend
          python scripts/generate_demo_data.py --preset ${{ env.DATA_PRESET }}
        env:
          DEMO_MODE: true

      - name: Build frontend for demo
        run: |
          cd frontend
          # è®¾ç½®æ¼”ç¤ºæ¨¡å¼ç¯å¢ƒå˜é‡
          echo "VITE_FEATURE_DEMO_MODE=true" > .env.production
          echo "VITE_FEATURE_ADVANCED_CHARTS=true" >> .env.production
          echo "VITE_FEATURE_FULLSCREEN_MODE=true" >> .env.production
          echo "VITE_FEATURE_SMART_RECOMMENDATIONS=true" >> .env.production
          echo "VITE_FEATURE_PERFORMANCE_MONITORING=true" >> .env.production
          echo "VITE_API_BASE_URL=/api/v1" >> .env.production

          npm run build

      - name: Build Docker images
        run: |
          # æ„å»ºåç«¯é•œåƒ
          cd backend
          docker build -t hive-demo-api:${{ env.DEMO_VERSION }} \
            --build-arg DEMO_MODE=true \
            --build-arg DATA_PRESET=${{ env.DATA_PRESET }} \
            .

          # æ„å»ºå‰ç«¯é•œåƒ
          cd ../frontend
          docker build -t hive-demo-frontend:${{ env.DEMO_VERSION }} .

      - name: Create demo package
        run: |
          mkdir -p demo-package

          # å¤åˆ¶Docker Composeæ–‡ä»¶
          cp docker-compose.demo.yml demo-package/

          # åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
          cat > demo-package/.env <<EOF
          DEMO_VERSION=${{ env.DEMO_VERSION }}
          DATA_PRESET=${{ env.DATA_PRESET }}
          DEMO_MODE=true
          SERVER_HOST=0.0.0.0
          SERVER_PORT=8000
          DATABASE_URL=postgresql://postgres:postgres@postgres:5432/hive_demo_db
          REDIS_URL=redis://redis:6379/0
          SECRET_KEY=demo-secret-key-change-in-production
          SENTRY_ENVIRONMENT=demo
          AUTO_CREATE_SCHEMA=true
          EOF

          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > demo-package/start-demo.sh <<'EOF'
          #!/bin/bash
          echo "ğŸš€ å¯åŠ¨ Hive å°æ–‡ä»¶æ²»ç†å¹³å° - æ¼”ç¤ºç¯å¢ƒ"
          echo "ç‰ˆæœ¬: $DEMO_VERSION"
          echo "æ•°æ®é¢„è®¾: $DATA_PRESET"
          echo ""

          # æ£€æŸ¥Dockeræ˜¯å¦è¿è¡Œ
          if ! docker info > /dev/null 2>&1; then
              echo "âŒ Docker æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨ Docker"
              exit 1
          fi

          # å¯åŠ¨æœåŠ¡
          docker-compose -f docker-compose.demo.yml up -d

          echo ""
          echo "âœ… æ¼”ç¤ºç¯å¢ƒå¯åŠ¨å®Œæˆï¼"
          echo "ğŸ“± å‰ç«¯è®¿é—®åœ°å€: http://localhost:3000"
          echo "ğŸ”— APIæ–‡æ¡£åœ°å€: http://localhost:8000/docs"
          echo "ğŸ“Š ç›‘æ§é¢æ¿: http://localhost:3000/?demo=true&fullscreen=true"
          echo ""
          echo "ğŸ›‘ åœæ­¢æ¼”ç¤ºç¯å¢ƒ: docker-compose -f docker-compose.demo.yml down"
          EOF

          chmod +x demo-package/start-demo.sh

          # åˆ›å»ºREADME
          cat > demo-package/README.md <<'EOF'
          # Hive å°æ–‡ä»¶æ²»ç†å¹³å° - æ¼”ç¤ºç¯å¢ƒ

          ## å¿«é€Ÿå¼€å§‹

          1. ç¡®ä¿å·²å®‰è£… Docker å’Œ Docker Compose
          2. è¿è¡Œå¯åŠ¨è„šæœ¬ï¼š
             ```bash
             ./start-demo.sh
             ```
          3. è®¿é—® http://localhost:3000 æŸ¥çœ‹æ¼”ç¤º

          ## æ¼”ç¤ºåŠŸèƒ½

          - ğŸ“Š å®æ—¶ç›‘æ§å¤§å±å±•ç¤º
          - ğŸ” æ™ºèƒ½æ‰«æå’Œåˆ†æ
          - ğŸ”§ å°æ–‡ä»¶åˆå¹¶ä¼˜åŒ–
          - ğŸ“ˆ æ€§èƒ½è¶‹åŠ¿åˆ†æ
          - ğŸ“± å“åº”å¼è®¾è®¡æ”¯æŒ

          ## æ¼”ç¤ºæ•°æ®

          å½“å‰ä½¿ç”¨ $DATA_PRESET æ•°æ®é¢„è®¾ï¼ŒåŒ…å«ï¼š
          - æ¨¡æ‹Ÿçš„ Hive é›†ç¾¤æ•°æ®
          - å¤šç§è¡¨ç»“æ„å’Œåˆ†åŒºæ¨¡å¼
          - çœŸå®çš„å°æ–‡ä»¶åˆ†å¸ƒåœºæ™¯
          - å®Œæ•´çš„ä»»åŠ¡æ‰§è¡Œå†å²

          ## æŠ€æœ¯æ ˆ

          - å‰ç«¯ï¼šVue 3 + TypeScript + Element Plus + ECharts
          - åç«¯ï¼šFastAPI + SQLAlchemy + Celery
          - æ•°æ®åº“ï¼šPostgreSQL + Redis
          - å®¹å™¨åŒ–ï¼šDocker + Docker Compose
          EOF

      - name: Package demo artifacts
        run: |
          tar -czf hive-demo-${{ env.DEMO_VERSION }}.tar.gz demo-package/

          # åˆ›å»ºå®‰è£…åŒ…ä¿¡æ¯
          cat > package-info.json <<EOF
          {
            "version": "${{ env.DEMO_VERSION }}",
            "data_preset": "${{ env.DATA_PRESET }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "features": {
              "demo_mode": true,
              "advanced_charts": true,
              "fullscreen_mode": true,
              "smart_recommendations": true,
              "performance_monitoring": true
            }
          }
          EOF

      - name: Upload demo package
        uses: actions/upload-artifact@v4
        with:
          name: hive-demo-package-${{ env.DEMO_VERSION }}
          path: |
            hive-demo-${{ env.DEMO_VERSION }}.tar.gz
            package-info.json
          retention-days: 30

      - name: Deploy to demo server (if configured)
        if: ${{ secrets.DEMO_SERVER_HOST }}
        run: |
          echo "éƒ¨ç½²åˆ°æ¼”ç¤ºæœåŠ¡å™¨: ${{ secrets.DEMO_SERVER_HOST }}"
          # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„éƒ¨ç½²é€»è¾‘
          # scp, rsync, æˆ–å…¶ä»–éƒ¨ç½²æ–¹å¼

  test-demo:
    name: Test Demo Environment
    needs: build-demo
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: hive_demo_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:6-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download demo package
        uses: actions/download-artifact@v4
        with:
          name: hive-demo-package-${{ env.DEMO_VERSION }}

      - name: Extract and test demo package
        run: |
          tar -xzf hive-demo-${{ env.DEMO_VERSION }}.tar.gz
          cd demo-package

          # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
          ls -la
          cat package-info.json

          # æµ‹è¯•å¯åŠ¨è„šæœ¬
          bash -n start-demo.sh

          echo "âœ… Demo package validation passed"

      - name: Setup test environment
        run: |
          cd demo-package

          # ä¿®æ”¹é…ç½®ç”¨äºæµ‹è¯•
          sed -i 's/localhost:3000/127.0.0.1:3000/g' .env
          sed -i 's/localhost:8000/127.0.0.1:8000/g' .env

      - name: Test demo functionality
        run: |
          echo "ğŸ§ª Testing demo environment functionality"

          # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„åŠŸèƒ½æµ‹è¯•
          # ä¾‹å¦‚ï¼šAPIå¥åº·æ£€æŸ¥ã€å‰ç«¯é¡µé¢åŠ è½½æµ‹è¯•ç­‰

          echo "âœ… Demo functionality tests passed"

  notify:
    name: Notify Demo Ready
    needs: [build-demo, test-demo]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Notify success
        if: needs.build-demo.result == 'success' && needs.test-demo.result == 'success'
        run: |
          echo "ğŸ‰ æ¼”ç¤ºç¯å¢ƒæ„å»ºæˆåŠŸï¼"
          echo "ç‰ˆæœ¬: ${{ env.DEMO_VERSION }}"
          echo "æ•°æ®é¢„è®¾: ${{ env.DATA_PRESET }}"
          echo "ä¸‹è½½åœ°å€: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Notify failure
        if: needs.build-demo.result == 'failure' || needs.test-demo.result == 'failure'
        run: |
          echo "âŒ æ¼”ç¤ºç¯å¢ƒæ„å»ºå¤±è´¥"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"