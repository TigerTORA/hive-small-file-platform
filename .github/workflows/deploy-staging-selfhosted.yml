name: Deploy Staging (Self-hosted)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Image version tag (e.g., 1.0.2)'
        required: true
        default: '1.0.2'

permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted, staging]
    env:
      VERSION: ${{ inputs.version }}
      IMAGE_OWNER: ${{ vars.IMAGE_OWNER || github.repository_owner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        shell: bash
        run: |
          echo "=== å®‰è£…Node.jsç¯å¢ƒ ==="
          # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…Node.js
          if command -v node >/dev/null 2>&1; then
            echo "Node.jså·²å®‰è£…: $(node --version)"
            echo "npmç‰ˆæœ¬: $(npm --version)"
          else
            echo "å®‰è£…Node.js..."
            # ä½¿ç”¨NodeSourceå®‰è£…Node.js 20ï¼ˆLTSï¼‰
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - || echo "NodeSourceè„šæœ¬æ‰§è¡Œå¤±è´¥"
            sudo apt-get install -y nodejs || echo "apt-getå®‰è£…å¤±è´¥"

            # å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå°è¯•ä½¿ç”¨snapå®‰è£…
            if ! command -v node >/dev/null 2>&1; then
              echo "å°è¯•ä½¿ç”¨snapå®‰è£…Node.js..."
              sudo snap install node --classic || echo "snapå®‰è£…å¤±è´¥"
            fi

            # å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œä¸‹è½½äºŒè¿›åˆ¶ç‰ˆæœ¬
            if ! command -v node >/dev/null 2>&1; then
              echo "ä¸‹è½½Node.jsäºŒè¿›åˆ¶ç‰ˆæœ¬..."
              cd /tmp
              curl -fsSL https://nodejs.org/dist/v18.18.0/node-v18.18.0-linux-x64.tar.xz -o node.tar.xz
              tar -xf node.tar.xz
              sudo cp -r node-v18.18.0-linux-x64/* /usr/local/
            fi
          fi

          # éªŒè¯å®‰è£…
          node --version && npm --version

      - name: Configure Docker Registry Mirrors
        shell: bash
        run: |
          set -e
          echo "=== é…ç½®Dockerå›½å†…é•œåƒæº ==="

          # åˆ›å»ºdockeré…ç½®ç›®å½•
          sudo mkdir -p /etc/docker

          # é…ç½®å›½å†…é•œåƒæº
          sudo tee /etc/docker/daemon.json > /dev/null <<'EOF'
          {
            "registry-mirrors": [
              "https://docker.m.daocloud.io",
              "https://mirror.ccs.tencentyun.com",
              "https://hub-mirror.c.163.com",
              "https://reg-mirror.qiniu.com",
              "https://dockerhub.azk8s.cn"
            ],
            "storage-driver": "overlay2"
          }
          EOF

          echo "Dockeré•œåƒæºé…ç½®å®Œæˆ:"
          cat /etc/docker/daemon.json

          # é‡å¯dockeræœåŠ¡ï¼ˆpodmanç¯å¢ƒå¯èƒ½ä¸éœ€è¦ï¼‰
          sudo systemctl daemon-reload || echo "systemctlä¸å¯ç”¨ï¼Œè·³è¿‡"
          sudo systemctl restart docker || echo "dockeræœåŠ¡é‡å¯è·³è¿‡"

          echo "=== éªŒè¯é•œåƒæºé…ç½® ==="
          docker info | grep -A 10 "Registry Mirrors" || echo "podmanç¯å¢ƒï¼Œé…ç½®å·²åº”ç”¨"

          echo "=== é…ç½®Podmané•œåƒæºï¼ˆå¦‚æœä½¿ç”¨podmanï¼‰ ==="
          # åˆ›å»ºpodmané…ç½®ç›®å½•
          mkdir -p ~/.config/containers

          # é…ç½®podmané•œåƒæº - ä½¿ç”¨v2æ ¼å¼
          tee ~/.config/containers/registries.conf > /dev/null <<'EOF'
          unqualified-search-registries = ["docker.io"]

          [[registry]]
          prefix = "docker.io"
          location = "docker.io"

          [[registry.mirror]]
          location = "docker.m.daocloud.io"

          [[registry.mirror]]
          location = "mirror.ccs.tencentyun.com"

          [[registry.mirror]]
          location = "hub-mirror.c.163.com"

          [[registry.mirror]]
          location = "reg-mirror.qiniu.com"
          EOF

          echo "Podmané•œåƒæºé…ç½®å®Œæˆ:"
          cat ~/.config/containers/registries.conf || echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"

      - name: Ensure docker compose plugin (v2)
        shell: bash
        run: |
          set -e
          mkdir -p ~/.docker/cli-plugins
          if ! docker compose version >/dev/null 2>&1; then
            curl -L -o ~/.docker/cli-plugins/docker-compose \
              https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64
            chmod +x ~/.docker/cli-plugins/docker-compose
          fi
          docker compose version

      - name: Write compose and env files (if missing)
        shell: bash
        run: |
          set -e
          cd /opt && mkdir -p hive-platform && cd hive-platform
          if [ ! -f docker-compose.prod.yml ]; then
            cat > docker-compose.prod.yml <<'EOF'
          version: '3.8'
          services:
            postgres:
              image: postgres:14
              container_name: hive-platform-db
              environment:
                POSTGRES_DB: hive_small_file_db
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: postgres
              volumes:
                - postgres_data:/var/lib/postgresql/data
              ports: [ "5432:5432" ]
              networks: [ hive-platform ]
            redis:
              image: redis:6-alpine
              container_name: hive-platform-redis
              ports: [ "6379:6379" ]
              volumes:
                - redis_data:/data
              networks: [ hive-platform ]
            api:
              image: ghcr.io/${{ env.IMAGE_OWNER }}/hive-small-file-api:${{ env.VERSION }}
              container_name: hive-platform-api
              env_file: [ backend/.env ]
              environment:
                - SENTRY_ENVIRONMENT=staging
                - AUTO_CREATE_SCHEMA=false
                - RELOAD=false
              depends_on: [ postgres, redis ]
              ports: [ "8000:8000" ]
              networks: [ hive-platform ]
            celery-worker:
              image: ghcr.io/${{ env.IMAGE_OWNER }}/hive-small-file-api:${{ env.VERSION }}
              container_name: hive-platform-worker
              command: celery -A app.scheduler.celery_app worker --loglevel=info --concurrency=4
              env_file: [ backend/.env ]
              environment: [ "SENTRY_ENVIRONMENT=staging" ]
              depends_on: [ postgres, redis ]
              networks: [ hive-platform ]
            celery-beat:
              image: ghcr.io/${{ env.IMAGE_OWNER }}/hive-small-file-api:${{ env.VERSION }}
              container_name: hive-platform-beat
              command: celery -A app.scheduler.celery_app beat --loglevel=info
              env_file: [ backend/.env ]
              environment: [ "SENTRY_ENVIRONMENT=staging" ]
              depends_on: [ postgres, redis ]
              networks: [ hive-platform ]
            frontend:
              image: ghcr.io/${{ env.IMAGE_OWNER }}/hive-small-file-frontend:${{ env.VERSION }}
              container_name: hive-platform-frontend
              depends_on: [ api ]
              ports: [ "80:80" ]
              networks: [ hive-platform ]
          volumes: { postgres_data: {}, redis_data: {} }
          networks: { hive-platform: { driver: bridge } }
          EOF
          fi
          mkdir -p backend frontend
          if [ ! -f backend/.env ]; then
            cat > backend/.env <<'EOF'
          SERVER_HOST=0.0.0.0
          SERVER_PORT=8000
          RELOAD=false
          DATABASE_URL=postgresql://postgres:postgres@postgres:5432/hive_small_file_db
          REDIS_URL=redis://redis:6379/0
          CELERY_BROKER_URL=redis://redis:6379/1
          CELERY_RESULT_BACKEND=redis://redis:6379/2
          SECRET_KEY=change-me-in-staging
          ACCESS_TOKEN_EXPIRE_MINUTES=1440
          DEFAULT_HIVE_HOST=localhost
          DEFAULT_HIVE_PORT=10000
          DEFAULT_HDFS_URL=http://namenode:9870/webhdfs/v1
          SMALL_FILE_THRESHOLD=134217728
          SENTRY_DSN=
          SENTRY_ENVIRONMENT=staging
          AUTO_CREATE_SCHEMA=false
          DEMO_MODE=false
          EOF
          fi
          if [ ! -f frontend/.env ]; then
            echo 'VITE_API_BASE_URL=/api/v1' > frontend/.env
          fi
          ls -lh docker-compose.prod.yml backend/.env frontend/.env

      - name: Deploy with Docker Compose (Persistent)
        shell: bash
        run: |
          echo "=== ä½¿ç”¨Docker ComposeæŒä¹…åŒ–éƒ¨ç½² ==="
          cd /opt/hive-platform

          # æ„å»ºæœ¬åœ°é•œåƒ
          echo "=== æ„å»ºåº”ç”¨é•œåƒ ==="
          cd ${{ github.workspace }}/backend
          docker build -t ghcr.io/tigertora/hive-small-file-api:${{ env.VERSION }} .

          cd ${{ github.workspace }}/frontend
          echo "å®‰è£…å‰ç«¯ä¾èµ–..."
          export PUPPETEER_SKIP_DOWNLOAD=true
          npm install --registry=https://registry.npmmirror.com
          echo "æ„å»ºå‰ç«¯..."
          npm run build
          echo "æ„å»ºå‰ç«¯é•œåƒ..."
          docker build -t ghcr.io/tigertora/hive-small-file-frontend:${{ env.VERSION }} .

          # è¿”å›éƒ¨ç½²ç›®å½•ï¼Œä½¿ç”¨composeéƒ¨ç½²
          cd /opt/hive-platform
          echo "=== ä½¿ç”¨Docker Composeéƒ¨ç½² ==="

          # å¼ºåˆ¶æ¸…ç†æ‰€æœ‰ç›¸å…³å®¹å™¨
          echo "æ¸…ç†æ—§å®¹å™¨..."
          docker rm -f hive-platform-db hive-platform-redis hive-platform-api hive-platform-frontend hive-platform-worker hive-platform-beat 2>/dev/null || true

          docker compose -f docker-compose.prod.yml down || true
          docker compose -f docker-compose.prod.yml up -d

          echo "=== ç­‰å¾…æœåŠ¡å¯åŠ¨ ==="
          sleep 30

          echo "=== æ£€æŸ¥æœåŠ¡çŠ¶æ€ ==="
          docker compose -f docker-compose.prod.yml ps

          echo "=== APIå¥åº·æ£€æŸ¥ ==="
          for i in {1..5}; do
            echo "ç¬¬ $i æ¬¡APIå¥åº·æ£€æŸ¥..."
            if curl -s --connect-timeout 5 --max-time 10 http://localhost:8000/health; then
              echo "âœ… APIæœåŠ¡å“åº”æ­£å¸¸ï¼"
              break
            else
              echo "â³ APIæœåŠ¡è¿˜æœªå°±ç»ªï¼Œç»§ç»­ç­‰å¾…... ($i/5)"
              sleep 10
            fi
          done

          echo ""
          echo "ğŸ‰ ===== éƒ¨ç½²å®ŒæˆçŠ¶æ€ ====="
          echo "ğŸ–¥ï¸  yunä¸»æœºIP: 115.190.156.197"
          echo "ğŸ”— APIå¥åº·æ£€æŸ¥: http://115.190.156.197:8000/health"
          echo "ğŸŒ å‰ç«¯åº”ç”¨: http://115.190.156.197/"
          echo "ğŸ“Š Hiveå°æ–‡ä»¶æ²»ç†å¹³å°å·²å°±ç»ªï¼"

      - name: DB migration
        shell: bash
        run: |
          cd /opt/hive-platform
          sleep 10 || true
          docker compose -f docker-compose.prod.yml exec api alembic upgrade head || true

      - name: Health checks
        shell: bash
        run: |
          echo 'API:'; curl -s http://127.0.0.1:8000/health || true
          echo 'FE :'; curl -s http://127.0.0.1/health || true

      - name: Detailed diagnosis
        shell: bash
        run: |
          echo "=== æ£€æŸ¥æ‰€æœ‰å¹³å°å®¹å™¨çŠ¶æ€ ==="
          docker ps -a | grep hive-platform || echo "æœªå‘ç°hive-platformå®¹å™¨"

          echo -e "\n=== æ£€æŸ¥Docker ComposeæœåŠ¡çŠ¶æ€ ==="
          cd /opt/hive-platform
          docker compose -f docker-compose.prod.yml ps || echo "composeçŠ¶æ€æ£€æŸ¥å¤±è´¥"

          echo -e "\n=== æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€ ==="
          netstat -tlnp | grep ":80\|:8000"

          echo -e "\n=== å‰ç«¯å®¹å™¨æ—¥å¿— ==="
          docker logs hive-platform-frontend --tail 20 2>/dev/null || echo "æ— æ³•è·å–å‰ç«¯æ—¥å¿—"

          echo -e "\n=== æµ‹è¯•æœ¬åœ°è®¿é—® ==="
          curl -I http://127.0.0.1/ 2>/dev/null || echo "æœ¬åœ°80ç«¯å£è®¿é—®å¤±è´¥"
          curl -I http://127.0.0.1:8000/health 2>/dev/null || echo "æœ¬åœ°APIè®¿é—®å¤±è´¥"

      - name: Emergency SSH and firewall fix
        shell: bash
        run: |
          echo "=== ç´§æ€¥SSHå’Œé˜²ç«å¢™ä¿®å¤ ==="

          # 1. æ£€æŸ¥å¹¶é‡å¯SSHæœåŠ¡
          echo "æ£€æŸ¥SSHæœåŠ¡..."
          sudo systemctl status ssh || sudo systemctl status sshd || echo "SSHæœåŠ¡æ£€æŸ¥"
          sudo systemctl restart ssh || sudo systemctl restart sshd || echo "SSHé‡å¯"

          # 2. æ¸…ç†å¹¶é‡ç½®é˜²ç«å¢™è§„åˆ™
          echo "é‡ç½®é˜²ç«å¢™è§„åˆ™..."
          sudo iptables -F INPUT || echo "æ¸…ç†INPUTé“¾"
          sudo iptables -P INPUT ACCEPT || echo "è®¾ç½®é»˜è®¤ç­–ç•¥ACCEPT"

          # 3. ç¡®ä¿SSHç«¯å£ä¼˜å…ˆå¼€æ”¾
          echo "ç¡®ä¿SSHç«¯å£å¼€æ”¾..."
          sudo iptables -I INPUT -p tcp --dport 22 -j ACCEPT || echo "SSHè§„åˆ™"

          # 4. æ·»åŠ åº”ç”¨ç«¯å£
          echo "æ·»åŠ åº”ç”¨ç«¯å£..."
          sudo iptables -I INPUT -p tcp --dport 80 -j ACCEPT || echo "80ç«¯å£"
          sudo iptables -I INPUT -p tcp --dport 8000 -j ACCEPT || echo "8000ç«¯å£"

          # 5. æ£€æŸ¥æœ€ç»ˆçŠ¶æ€
          echo "=== æœ€ç»ˆçŠ¶æ€ ==="
          echo "SSHæœåŠ¡:"
          sudo systemctl is-active ssh || sudo systemctl is-active sshd || echo "SSHçŠ¶æ€æ£€æŸ¥"
          echo "ç«¯å£ç›‘å¬:"
          netstat -tlnp | grep ":22\|:80\|:8000" || echo "ç«¯å£æ£€æŸ¥å®Œæˆ"

          echo "=== SSHä¿®å¤å®Œæˆï¼Œå¯ä»¥å°è¯•é‡æ–°è¿æ¥ ==="

