#!/bin/bash

# Hive å°æ–‡ä»¶æ²»ç†å¹³å° - å¼ºåˆ¶æµ‹è¯•ä»ªè¡¨æ¿æ›´æ–°è§„åˆ™
# æ¯æ¬¡æäº¤å‰å¿…é¡»æ›´æ–°æµ‹è¯•ä»ªè¡¨æ¿æ•°æ®

set -e

echo "ğŸ” æ‰§è¡Œå¼ºåˆ¶æµ‹è¯•ä»ªè¡¨æ¿æ›´æ–°æ£€æŸ¥..."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# æ£€æŸ¥æµ‹è¯•ä»ªè¡¨æ¿é›†æˆæœåŠ¡æ˜¯å¦è¿è¡Œ
TEST_SERVICE_URL="http://localhost:3001/api/health"
FRONTEND_URL="http://localhost:3002"

echo "ğŸ“¡ æ£€æŸ¥æµ‹è¯•ä»ªè¡¨æ¿æœåŠ¡çŠ¶æ€..."

# æ£€æŸ¥APIæœåŠ¡
if ! curl -s -f "$TEST_SERVICE_URL" > /dev/null 2>&1; then
    echo "âŒ æµ‹è¯•ä»ªè¡¨æ¿APIæœåŠ¡æœªè¿è¡Œï¼"
    echo "ğŸ’¡ è¯·å…ˆå¯åŠ¨æœåŠ¡ï¼š"
    echo "   cd frontend && node test-dashboard-integration.js &"
    echo ""
    echo "ğŸš« æäº¤è¢«é˜»æ­¢ - æµ‹è¯•ä»ªè¡¨æ¿æœåŠ¡å¿…é¡»è¿è¡Œ"
    exit 1
fi

echo "âœ… æµ‹è¯•ä»ªè¡¨æ¿APIæœåŠ¡æ­£å¸¸è¿è¡Œ"

# æ£€æŸ¥å‰ç«¯æœåŠ¡
if ! curl -s -f "$FRONTEND_URL" > /dev/null 2>&1; then
    echo "âŒ å‰ç«¯å¼€å‘æœåŠ¡å™¨æœªè¿è¡Œï¼"
    echo "ğŸ’¡ è¯·å…ˆå¯åŠ¨æœåŠ¡ï¼š"
    echo "   cd frontend && npm run dev &"
    echo ""
    echo "ğŸš« æäº¤è¢«é˜»æ­¢ - å‰ç«¯æœåŠ¡å¿…é¡»è¿è¡Œ"
    exit 1
fi

echo "âœ… å‰ç«¯å¼€å‘æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ"

# å¼ºåˆ¶åˆ·æ–°æµ‹è¯•æ•°æ®
echo "ğŸ”„ å¼ºåˆ¶åˆ·æ–°æµ‹è¯•ä»ªè¡¨æ¿æ•°æ®..."

REFRESH_RESULT=$(curl -s -X POST "http://localhost:3001/api/test/refresh")
if [[ $? -ne 0 ]]; then
    echo "âŒ æµ‹è¯•æ•°æ®åˆ·æ–°å¤±è´¥ï¼"
    echo "ğŸš« æäº¤è¢«é˜»æ­¢ - å¿…é¡»æˆåŠŸæ›´æ–°æµ‹è¯•ä»ªè¡¨æ¿"
    exit 1
fi

echo "âœ… æµ‹è¯•æ•°æ®åˆ·æ–°æˆåŠŸ"

# è·å–æœ€æ–°æµ‹è¯•ç»Ÿè®¡
echo "ğŸ“Š è·å–æœ€æ–°æµ‹è¯•ç»Ÿè®¡..."
OVERVIEW=$(curl -s "http://localhost:3001/api/test/overview")
TOTAL_TESTS=$(echo "$OVERVIEW" | jq -r '.data.totalTests // 0')
SUCCESS_RATE=$(echo "$OVERVIEW" | jq -r '.data.successRate // 0')

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“ˆ å½“å‰æµ‹è¯•çŠ¶æ€ï¼š"
echo "   æ€»æµ‹è¯•æ•°: $TOTAL_TESTS"
echo "   æˆåŠŸç‡: ${SUCCESS_RATE}%"
echo "   ä»ªè¡¨æ¿åœ°å€: http://localhost:3002/#/test-dashboard"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# æ£€æŸ¥æœ€ä½æµ‹è¯•è¦†ç›–ç‡è¦æ±‚ï¼ˆå¯é€‰ï¼‰
MIN_SUCCESS_RATE=30
if [[ $SUCCESS_RATE -lt $MIN_SUCCESS_RATE ]]; then
    echo "âš ï¸  è­¦å‘Šï¼šæµ‹è¯•æˆåŠŸç‡ (${SUCCESS_RATE}%) ä½äºæœ€ä½è¦æ±‚ (${MIN_SUCCESS_RATE}%)"
    echo "ğŸ’¡ å»ºè®®æé«˜æµ‹è¯•è´¨é‡åå†æäº¤"
    # è¿™é‡Œå¯ä»¥è®¾ç½®ä¸ºå¼ºåˆ¶å¤±è´¥ï¼šexit 1
fi

# è®°å½•æµ‹è¯•ä»ªè¡¨æ¿æ›´æ–°æ—¶é—´æˆ³
echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" > .last-dashboard-update

echo "âœ… æµ‹è¯•ä»ªè¡¨æ¿æ›´æ–°å®Œæˆ - å…è®¸æäº¤"
echo ""