<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试任务日志功能 - 最终验证</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .task-item { border: 1px solid #e5e7eb; margin: 10px 0; padding: 15px; border-radius: 6px; }
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .task-id { font-family: monospace; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status.failed { background: #fee2e2; color: #dc2626; }
        .status.success { background: #dcfce7; color: #16a34a; }
        .status.running { background: #dbeafe; color: #2563eb; }
        .logs { background: #1f2937; color: #fff; padding: 15px; border-radius: 6px; margin-top: 10px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 13px; }
        .log-entry { margin: 5px 0; padding: 8px; border-left: 3px solid #374151; }
        .log-entry.error { border-left-color: #dc2626; background: rgba(220, 38, 38, 0.1); }
        .log-entry.info { border-left-color: #2563eb; background: rgba(37, 99, 235, 0.1); }
        .log-meta { color: #9ca3af; font-size: 11px; margin-top: 4px; }
        button { margin: 5px; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .loading { color: #6b7280; font-style: italic; }
        .error-msg { color: #dc2626; background: #fee2e2; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success-msg { color: #16a34a; background: #dcfce7; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>测试任务日志功能 - 最终验证</h1>

        <div class="section">
            <h3>前端TaskRunAdapters功能测试</h3>
            <p>这个页面模拟前端组件的loadTestTableRun函数，测试是否能正确获取和显示测试表任务日志。</p>
            <button class="btn-primary" onclick="testLoadTestTableRun()">测试 loadTestTableRun 函数</button>
            <button class="btn-secondary" onclick="clearResults()">清空结果</button>
            <div id="results"></div>
        </div>

        <div class="section">
            <h3>已知测试任务列表</h3>
            <div id="task-list">
                <p class="loading">正在加载任务列表...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';

        // 模拟前端 loadTestTableRun 函数
        async function loadTestTableRun(taskId) {
            console.log('开始测试 loadTestTableRun 函数，任务ID:', taskId);

            let logs = [];
            let taskInfo = null;

            try {
                // 获取日志 (模拟 tasksApi.getLogs)
                const logsResponse = await fetch(`${API_BASE}/tasks/${taskId}/logs`);
                if (!logsResponse.ok) {
                    throw new Error(`日志API返回错误: ${logsResponse.status}`);
                }
                logs = await logsResponse.json();
                console.log('Test table logs loaded:', logs);
            } catch (e) {
                console.warn('Failed to load test table logs:', e);
                logs = [];
            }

            // 尝试获取任务详情
            try {
                const taskResponse = await fetch(`${API_BASE}/test-tables/tasks/${taskId}`);
                if (!taskResponse.ok) {
                    throw new Error(`任务详情API返回错误: ${taskResponse.status}`);
                }
                taskInfo = await taskResponse.json();
                console.log('Test table task info:', taskInfo);
            } catch (e) {
                console.warn('Failed to load test table task info:', e);
            }

            // 测试表生成的阶段
            const steps = [
                { id: 'initialization', name: '初始化', status: 'pending' },
                { id: 'hdfs_setup', name: '创建HDFS目录', status: 'pending' },
                { id: 'data_generation', name: '生成数据文件', status: 'pending' },
                { id: 'hive_table_creation', name: '创建Hive表', status: 'pending' },
                { id: 'partition_creation', name: '添加分区', status: 'pending' },
                { id: 'verification', name: '验证结果', status: 'pending' },
                { id: 'completed', name: '完成', status: 'pending' }
            ];

            // 检查是否有错误日志来确定状态
            const hasError = (logs || []).some(l => (l.log_level || '').toUpperCase() === 'ERROR');
            let status = taskInfo?.status || 'running';

            // 根据任务状态更新步骤状态
            if (status === 'success') {
                steps.forEach(step => step.status = 'success');
            } else if (status === 'failed' || hasError) {
                steps[0].status = 'success';  // 初始化总是成功的
                steps.forEach((step, index) => {
                    if (index > 0) step.status = 'failed';
                });
                status = 'failed';
            } else if (status === 'running') {
                steps[0].status = 'success';  // 初始化完成
                steps[1].status = 'running';  // 当前在创建HDFS目录阶段
            }

            const normLogs = (logs || []).map(l => ({
                ts: String(l.timestamp || ''),
                level: levelMap(l.log_level),
                source: 'test-table',
                message: l.message || '',
                step_id: l.phase || 'initialization'
            }));

            return {
                title: taskInfo?.task_name || '测试表生成任务',
                status,
                progress: taskInfo?.progress_percentage || 0,
                currentOperation: taskInfo?.current_operation || (hasError ? '执行失败' : '正在执行'),
                startedAt: taskInfo?.started_time,
                finishedAt: taskInfo?.completed_time,
                steps,
                logs: normLogs
            };
        }

        // 级别映射函数
        function levelMap(s) {
            const up = (s || '').toUpperCase();
            return up === 'WARN' ? 'WARN' : up === 'ERROR' ? 'ERROR' : up === 'DEBUG' ? 'DEBUG' : 'INFO';
        }

        // 测试 loadTestTableRun 函数
        async function testLoadTestTableRun() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p class="loading">正在测试 loadTestTableRun 函数...</p>';

            const taskId = '274486bd-8c6f-4c55-806f-80dbdab621fc'; // 使用已知的测试任务ID

            try {
                const result = await loadTestTableRun(taskId);

                let html = `
                    <div class="success-msg">✅ loadTestTableRun 函数测试成功！</div>
                    <div class="task-item">
                        <div class="task-header">
                            <div>
                                <strong>${result.title}</strong>
                                <span class="task-id">${taskId}</span>
                            </div>
                            <span class="status ${result.status}">${result.status}</span>
                        </div>
                        <div>
                            <strong>进度:</strong> ${result.progress}% |
                            <strong>当前操作:</strong> ${result.currentOperation || 'N/A'}
                        </div>
                        <div>
                            <strong>步骤数量:</strong> ${result.steps.length} |
                            <strong>日志数量:</strong> ${result.logs.length}
                        </div>
                        <div>
                            <strong>开始时间:</strong> ${result.startedAt || 'N/A'} |
                            <strong>结束时间:</strong> ${result.finishedAt || 'N/A'}
                        </div>

                        <h4>执行步骤:</h4>
                        <div>
                            ${result.steps.map(step => `
                                <span class="status ${step.status}" style="margin: 2px;">${step.name} (${step.status})</span>
                            `).join('')}
                        </div>

                        <h4>执行日志:</h4>
                        <div class="logs">
                            ${result.logs.map(log => `
                                <div class="log-entry ${log.level.toLowerCase()}">
                                    <strong>[${log.level}]</strong> ${log.message}
                                    <div class="log-meta">时间: ${log.ts} | 来源: ${log.source} | 阶段: ${log.step_id}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error-msg">❌ loadTestTableRun 函数测试失败: ${error.message}</div>
                    <pre>${error.stack || ''}</pre>
                `;
            }
        }

        // 加载任务列表
        async function loadTaskList() {
            try {
                const response = await fetch(`${API_BASE}/tasks/?limit=10`);
                if (!response.ok) {
                    throw new Error(`API返回错误: ${response.status}`);
                }
                const tasks = await response.json();

                const testTableTasks = tasks.filter(task => task.type === 'test-table-generation');

                const container = document.getElementById('task-list');

                if (testTableTasks.length === 0) {
                    container.innerHTML = '<p>没有找到测试表生成任务</p>';
                    return;
                }

                let html = '';
                testTableTasks.forEach(task => {
                    html += `
                        <div class="task-item">
                            <div class="task-header">
                                <div>
                                    <strong>${task.task_name || '未命名任务'}</strong>
                                    <span class="task-id">${task.id}</span>
                                </div>
                                <span class="status ${task.status}">${task.status}</span>
                            </div>
                            <div>
                                <strong>类型:</strong> ${task.type} |
                                <strong>进度:</strong> ${task.progress || 0}%
                            </div>
                            <button class="btn-primary" onclick="testSpecificTask('${task.id}')">
                                测试此任务的日志功能
                            </button>
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                document.getElementById('task-list').innerHTML =
                    `<div class="error-msg">加载任务列表失败: ${error.message}</div>`;
            }
        }

        // 测试特定任务
        async function testSpecificTask(taskId) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<p class="loading">正在测试任务 ${taskId} 的日志功能...</p>`;

            try {
                const result = await loadTestTableRun(taskId);

                let html = `
                    <div class="success-msg">✅ 任务 ${taskId} 的日志功能测试成功！</div>
                    <div class="task-item">
                        <div class="task-header">
                            <div>
                                <strong>${result.title}</strong>
                                <span class="task-id">${taskId}</span>
                            </div>
                            <span class="status ${result.status}">${result.status}</span>
                        </div>

                        <h4>执行日志 (${result.logs.length} 条):</h4>
                        <div class="logs">
                            ${result.logs.map(log => `
                                <div class="log-entry ${log.level.toLowerCase()}">
                                    <strong>[${log.level}]</strong> ${log.message}
                                    <div class="log-meta">时间: ${log.ts}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error-msg">❌ 任务 ${taskId} 的日志功能测试失败: ${error.message}</div>
                `;
            }
        }

        // 清空结果
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // 页面加载时自动加载任务列表
        window.onload = loadTaskList;
    </script>
</body>
</html>