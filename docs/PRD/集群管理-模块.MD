# 集群管理模块功能需求（基于当前实现）

> 文档版本：v0.3（2025-10-29）  
> 说明：以下内容基于现有代码整理，主要涵盖前端 `frontend/src/views/ClustersManagement.vue`、`frontend/src/views/ClusterDetail.vue` 以及后端 `backend/app/api/clusters.py`。

## 1. 集群列表页（ClustersManagement）
- 采用卡片视图展示集群名称、描述、Hive 地址以及数据库/表/小文件统计。
- 顶部操作栏：
  - “配置模板”下拉：应用预置的 CDP/CDH/HDP 配置模板到新增表单。
  - `严格实连` 开关（`strictReal`）：控制触发扫描时是否强制真实连通。
  - `添加集群` 按钮：打开新增弹窗。
- 卡片右上角 `ConnectionStatusIndicator` 显示 HiveServer2 / HDFS / MetaStore 连通状态，并支持单组件即时测试。
- 卡片操作区：
  - `连接测试` 按钮：调用 `POST /clusters/{id}/test?mode=enhanced` 打开连接测试对话框。
  - `编辑`：打开表单并回填当前集群配置。
  - 更多操作（…）：当前仅提供 `删除集群`，调用 `DELETE /clusters/{id}`，后端会级联清理相关数据。
- 点击卡片或“进入集群详情”按钮跳转到 `ClusterDetail` 页面。
- 搜索与状态过滤逻辑（`searchText`、`statusFilter`）已在脚本中预留，但界面暂未暴露输入控件；文档需标注为待启用能力。

## 2. 新增 / 编辑表单
- 字段与默认值：
  - 集群名称（必填）、描述。
  - Hive 主机（必填）、端口（默认 10000）。
  - MetaStore URL（必填，需要 `mysql://` / `postgresql://` / `sqlite://` 前缀）。
  - HDFS/HttpFS 地址（必填，仅支持 WebHDFS / HttpFS URL），HDFS 用户（默认 `hdfs`，若启用 Kerberos 请填写对应 Kerberos 账号）。
  - Hive 认证配置：支持 `NONE`、`LDAP`、`KERBEROS`，并按选择动态展示用户名/密码或 Kerberos 相关字段。
  - YARN Resource Manager（可选，支持逗号分隔多地址；当前仅支持非 Kerberos 访问，如需 Kerberos 需额外实现）。
  - 小文件阈值（默认 128MB，可调）。
  - `创建前验证连接` 复选框（仅在新增时可见）。
  > 注：原 HAR SSH 配置已在 2025-10-29 的 ADR（`docs/ADR/2025-10-29-har-ssh-config-and-yarn-kerberos.md`）中决定下线，前端不再提供对应入口；依赖该配置的 EC 策略与 HDFS Mover 功能暂时禁用。
- 表单为单页布局，使用 Element Plus 表单校验；LDAP/Kerberos 字段通过自定义校验器在选择对应认证方式时强制填写。
- 新增：
  - `POST /clusters/` 创建集群。
  - 若勾选验证连接，则调用 `POST /clusters/?validate_connection=true`，失败会返回详细诊断。
- 编辑：调用 `PUT /clusters/{id}`，后端仅更新传入字段。
- 表单提供“测试连接”按钮（新增场景），调用 `POST /clusters/test-connection` 对当前配置做离线验证。
- 说明：后端仍支持 `hive_database` 字段，前端未暴露输入，默认写入 `default`。

## 3. 连接测试能力
- 通用弹窗组件 `ConnectionTestDialog.vue` 展示整体状态、MetaStore/HDFS/Beeline 等组件的结果、诊断信息、日志与建议，支持“重新测试”及单组件重测。
- 已实现接口：
  - `POST /clusters/{id}/test`：根据 `mode`（mock/real）执行测试；增强模式在列表页通过 `testConnection(cluster, 'enhanced')` 间接调用。
  - `POST /clusters/test-connection`：对未落库配置进行验证。
  - `POST /clusters/{id}/test-enhanced`：支持指定连接类型、强制刷新缓存。

## 4. 集群详情页（ClusterDetail）
- 顶部卡片显示集群基础信息与状态标签，提供“测试连接”“扫描数据库”入口。
- 指标面板：调用 `GET /clusters/{id}/stats` 展示总数据库数、总表数、小文件表数、小文件总数。
- 标签页结构：
  - `表管理`：嵌入 `TablesView`，展示表指标及操作。
  - `任务管理`：嵌入 `TasksView`，查看合并/扫描任务。
  - `小文件分析`：展示趋势与热点。
  - `设置`：嵌入 `ClusterSettings`，可更新配置并触发刷新。
- 数据库扫描：
  - 对话框支持“扫描全部数据库”或“指定单库”。
  - 分别调用 `POST /clusters/{id}/scan-all`、`POST /clusters/{id}/scan-database`。
  - 扫描执行详情通过 `TaskRunDialog` 呈现。

## 5. 删除与级联清理
- `DELETE /clusters/{id}` 按顺序清理关联数据：`scan_task_logs` → `scan_tasks` → `task_logs` → `merge_tasks` → `partition_metrics` → `table_metrics`，最后删除集群行。
- 返回删除成功信息及关联记录数；前端删除后刷新列表。

## 6. 其余相关接口
- `GET /clusters/`：分页列出集群，后端屏蔽 `hive_password`。
- `GET /clusters/{id}`：单集群详情。
- `GET /clusters/{id}/databases`：优先读取已扫描结果，缺失时直连 MetaStore。
- `GET /clusters/health-metrics`、`POST /clusters/batch-health-check`：健康巡检指标与批量测试接口，当前 UI 未挂载，可作为后续扩展。

---

如未来增加搜索筛选、标签管理、审批流或批量操作，请在本文件增补“待实现”章节，记录设计与依赖以保持文档与实现一致。
