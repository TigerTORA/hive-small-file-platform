<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试表任务日志调试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .logs { background: #f8f8f8; padding: 10px; margin: 10px 0; max-height: 400px; overflow-y: auto; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        button { margin: 5px; padding: 8px 15px; }
        input { margin: 5px; padding: 5px; width: 300px; }
    </style>
</head>
<body>
    <h1>测试表任务日志调试页面</h1>

    <div class="section">
        <h3>1. 测试已知任务的日志</h3>
        <button onclick="testKnownTask()">测试成功任务 (8c3a0078-33b2-4b75-a5bc-414eb09f4284)</button>
        <button onclick="testFailedTask()">测试失败任务 (26e8c07c-4eca-47de-96d6-b9814c0e89e3)</button>
        <div id="known-results" class="logs"></div>
    </div>

    <div class="section">
        <h3>2. 测试自定义任务ID</h3>
        <input type="text" id="taskId" placeholder="输入任务ID" value="26e8c07c-4eca-47de-96d6-b9814c0e89e3">
        <button onclick="testCustomTask()">获取日志</button>
        <button onclick="testTaskInfo()">获取任务信息</button>
        <div id="custom-results" class="logs"></div>
    </div>

    <div class="section">
        <h3>3. 模拟前端加载逻辑</h3>
        <button onclick="simulateLoadTestTableRun()">模拟 loadTestTableRun 函数</button>
        <div id="simulate-results" class="logs"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';

        // 测试成功任务
        async function testKnownTask() {
            const taskId = '8c3a0078-33b2-4b75-a5bc-414eb09f4284';
            await testTaskLogs(taskId, 'known-results');
        }

        // 测试失败任务
        async function testFailedTask() {
            const taskId = '26e8c07c-4eca-47de-96d6-b9814c0e89e3';
            await testTaskLogs(taskId, 'known-results');
        }

        // 测试自定义任务
        async function testCustomTask() {
            const taskId = document.getElementById('taskId').value;
            await testTaskLogs(taskId, 'custom-results');
        }

        // 获取任务信息
        async function testTaskInfo() {
            const taskId = document.getElementById('taskId').value;
            const resultsDiv = document.getElementById('custom-results');

            try {
                const response = await fetch(`${API_BASE}/test-tables/tasks/${taskId}`);
                const data = await response.json();
                resultsDiv.innerHTML = `<div class="success">任务信息获取成功:</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">获取任务信息失败: ${error.message}</div>`;
            }
        }

        // 通用测试日志函数
        async function testTaskLogs(taskId, resultsDivId) {
            const resultsDiv = document.getElementById(resultsDivId);
            resultsDiv.innerHTML = '<div class="info">正在获取日志...</div>';

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}/logs`);
                const logs = await response.json();

                let html = `<div class="success">日志获取成功 (${logs.length} 条):</div>`;
                logs.forEach((log, index) => {
                    const levelClass = log.log_level === 'ERROR' ? 'error' : 'info';
                    html += `
                        <div class="${levelClass}">
                            <strong>[${log.log_level}]</strong> ${log.message}
                            <br><small>时间: ${log.timestamp} | 阶段: ${log.phase}</small>
                        </div>
                    `;
                });
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">获取日志失败: ${error.message}</div>`;
            }
        }

        // 模拟前端加载逻辑
        async function simulateLoadTestTableRun() {
            const taskId = document.getElementById('taskId').value || '26e8c07c-4eca-47de-96d6-b9814c0e89e3';
            const resultsDiv = document.getElementById('simulate-results');
            resultsDiv.innerHTML = '<div class="info">模拟加载中...</div>';

            try {
                // 模拟 loadTestTableRun 函数的逻辑
                let logs = [];
                let taskInfo = null;

                // 获取日志
                try {
                    const logsResponse = await fetch(`${API_BASE}/tasks/${taskId}/logs`);
                    logs = await logsResponse.json();
                    console.log('Test table logs loaded:', logs);
                } catch (e) {
                    console.warn('Failed to load test table logs:', e);
                    logs = [];
                }

                // 获取任务详情
                try {
                    const taskResponse = await fetch(`${API_BASE}/test-tables/tasks/${taskId}`);
                    taskInfo = await taskResponse.json();
                    console.log('Test table task info:', taskInfo);
                } catch (e) {
                    console.warn('Failed to load test table task info:', e);
                }

                // 构建结果
                const hasError = (logs || []).some(l => (l.log_level || '').toUpperCase() === 'ERROR');
                const status = taskInfo?.status || 'unknown';

                let html = `
                    <div class="success">模拟加载完成:</div>
                    <div><strong>任务状态:</strong> ${status}</div>
                    <div><strong>日志数量:</strong> ${logs.length}</div>
                    <div><strong>有错误:</strong> ${hasError ? '是' : '否'}</div>
                    <div><strong>任务名称:</strong> ${taskInfo?.task_name || 'N/A'}</div>
                    <div><strong>进度:</strong> ${taskInfo?.progress_percentage || 0}%</div>
                    <div><strong>当前操作:</strong> ${taskInfo?.current_operation || 'N/A'}</div>
                    <h4>日志内容:</h4>
                `;

                logs.forEach(log => {
                    const levelClass = log.log_level === 'ERROR' ? 'error' : 'info';
                    html += `
                        <div class="${levelClass}">
                            <strong>[${log.log_level}]</strong> ${log.message}
                            <br><small>时间: ${log.timestamp} | 阶段: ${log.phase}</small>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">模拟加载失败: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>