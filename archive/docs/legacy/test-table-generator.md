# 测试表生成器使用指南

## 概述

测试表生成器是小文件治理平台的一个重要工具，专门用于快速创建包含大量小文件的Hive外部表，为小文件治理功能提供测试数据。

## 功能特性

### 🎯 核心功能
- **一键生成**：通过Web界面快速创建测试表
- **多种场景**：预设轻量、默认、重度、极限四种测试场景
- **自定义配置**：支持自定义分区数、文件数、文件大小等参数
- **实时进度**：通过WebSocket实时显示创建进度
- **结果验证**：自动验证创建结果的完整性

### 📊 预设测试场景

| 场景 | 分区数 | 每分区文件数 | 单文件大小 | 总文件数 | 预估时间 | 适用场景 |
|------|--------|-------------|-----------|----------|----------|----------|
| 轻量测试 | 5 | 20 | 30KB | 100 | 1-2分钟 | 开发环境功能验证 |
| 默认测试 | 10 | 100 | 50KB | 1,000 | 5-10分钟 | 完整功能测试 |
| 重度测试 | 20 | 100 | 60KB | 2,000 | 10-20分钟 | 性能测试 |
| 极限测试 | 100 | 100 | 64KB | 10,000 | 30-60分钟 | 压力测试（慎用）|

## 使用步骤

### 1. 访问测试表生成器

在小文件治理平台的左侧导航栏中，找到"系统管理" -> "测试表生成器"。

### 2. 选择测试场景

根据测试需求选择合适的预设场景：
- **开发测试**：选择"轻量测试"
- **功能验证**：选择"默认测试"
- **性能评估**：选择"重度测试"
- **压力测试**：选择"极限测试"（仅在专用环境使用）

### 3. 配置参数

#### 基础配置
- **集群**：选择目标Hive集群
- **表名**：设置测试表名称（默认：test_small_files_table）
- **数据库名**：设置数据库名称（默认：test_db）
- **HDFS路径**：设置数据存储路径（默认：/user/test/small_files_test）

#### 高级配置（自定义场景）
- **分区数量**：1-1000个分区
- **每分区文件数**：1-1000个文件
- **单文件大小**：1-1024KB

#### 安全选项
- **强制重新创建**：删除已存在的表和数据（谨慎使用）

### 4. 验证配置

点击"验证配置"按钮检查参数设置，系统会显示：
- 预估文件总数
- 预估磁盘占用
- 预估执行时间
- 配置警告信息

### 5. 创建测试表

点击"创建测试表"按钮启动创建任务，系统将：
1. 自动创建HDFS目录结构
2. 并发生成测试数据文件
3. 创建Hive外部表
4. 添加分区映射
5. 验证创建结果

### 6. 监控进度

创建过程中可以实时查看：
- 执行进度百分比
- 当前执行阶段
- 当前操作内容
- 实时执行日志

## 创建后的验证

### 自动验证
系统会自动验证：
- HDFS文件数量是否正确
- Hive分区是否正确添加
- 表结构是否正确创建

### 手动验证
可以通过以下命令验证创建结果：

```sql
-- 查看表结构
USE test_db;
DESCRIBE FORMATTED test_small_files_table;

-- 查看分区
SHOW PARTITIONS test_small_files_table;

-- 查询数据样本
SELECT * FROM test_small_files_table LIMIT 10;

-- 统计数据量
SELECT COUNT(*) FROM test_small_files_table;
```

```bash
# 检查HDFS文件
hdfs dfs -find /user/test/small_files_test -name "*.txt" | head -20

# 检查小文件情况
hdfs fsck /user/test/small_files_test -files -blocks
```

## 与治理平台集成

创建测试表后，可以在治理平台中进行以下操作：

### 1. 监控中心
- 查看集群小文件统计
- 观察小文件分布图表
- 分析文件大小分布

### 2. 表管理
- 扫描新创建的测试表
- 查看表的小文件详情
- 分析分区级别的文件分布

### 3. 任务管理
- 创建合并任务测试治理效果
- 监控任务执行状态
- 查看合并前后对比

## 最佳实践

### 开发环境
- 使用"轻量测试"场景进行功能验证
- 设置合适的HDFS测试路径
- 及时清理不需要的测试数据

### 测试环境
- 使用"默认测试"或"重度测试"场景
- 测试完整的治理流程
- 验证不同合并策略的效果

### 生产环境
- **强烈建议不要**在生产环境使用此工具
- 如必须使用，请使用"轻量测试"场景
- 确保HDFS路径不会影响生产数据

## 清理测试数据

### 通过界面清理
在"历史任务"表格中，点击对应任务的"删除"按钮。

### 手动清理
```bash
# 删除HDFS数据
hdfs dfs -rm -r /user/test/small_files_test

# 删除Hive表
hive -e "DROP DATABASE IF EXISTS test_db CASCADE;"
```

## 故障排除

### 常见问题

**Q: 创建失败，提示hive命令未找到**
A: 确保Hive客户端已安装并在PATH中：
```bash
export HIVE_HOME=/path/to/hive
export PATH=$HIVE_HOME/bin:$PATH
```

**Q: HDFS权限错误**
A: 检查用户HDFS权限：
```bash
hdfs dfs -ls /user/
hdfs dfs -mkdir /user/$USER
hdfs dfs -chown $USER:$USER /user/$USER
```

**Q: 创建过程中断**
A: 检查集群连接状态，必要时重新创建任务。

**Q: 文件数量不符**
A: 检查并发设置和磁盘空间，可能需要调整配置。

### 性能优化

**文件生成慢**
- 减少单次并发文件数
- 检查网络和磁盘性能
- 适当调整文件大小

**内存不足**
- 减少分区数或每分区文件数
- 增加JVM堆内存
- 使用更小的文件大小

## API接口

测试表生成器提供完整的REST API：

```bash
# 获取预设场景
GET /api/v1/test-tables/scenarios

# 创建测试表
POST /api/v1/test-tables/create

# 查看任务状态
GET /api/v1/test-tables/tasks/{task_id}

# 验证配置
GET /api/v1/test-tables/config/validate

# 验证测试表
POST /api/v1/test-tables/verify

# 删除测试表
POST /api/v1/test-tables/delete
```

详细的API文档可在 `http://localhost:8000/docs` 查看。

## 注意事项

### 安全警告
⚠️ **重要**：此工具专门设计用于创建大量小文件来测试治理平台。请勿在生产环境使用，以免影响集群性能。

### 资源消耗
- 大量文件创建会消耗较多CPU和内存资源
- 建议在非高峰时段进行测试
- 监控集群资源使用情况

### 数据管理
- 定期清理不需要的测试数据
- 避免在同一集群创建多个大型测试表
- 记录测试表的用途和清理时间

## 技术架构

### 后端架构
- **API层**：FastAPI RESTful接口
- **服务层**：异步任务执行服务
- **脚本层**：Shell脚本自动化执行
- **通信层**：WebSocket实时进度推送

### 前端架构
- **Vue 3**：响应式用户界面
- **Element Plus**：UI组件库
- **WebSocket**：实时进度显示
- **TypeScript**：类型安全

### 执行流程
1. 参数验证和配置生成
2. 动态脚本生成
3. 异步任务执行
4. 实时进度广播
5. 结果验证和反馈

---

通过测试表生成器，您可以快速为小文件治理平台创建真实的测试环境，验证各种治理策略的效果。如有问题，请查看系统日志或联系技术支持。